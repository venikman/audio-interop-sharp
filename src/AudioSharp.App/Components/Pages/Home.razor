@page "/"
@rendermode InteractiveServer
@implements IDisposable
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@using AudioSharp.App.Data
@using AudioSharp.App.Models
@using AudioSharp.App.Options
@using AudioSharp.App.Services
@inject IJSRuntime JsRuntime
@inject IAudioProcessingService AudioProcessingService
@inject IConcernExtractionService ConcernExtractionService
@inject IFollowUpQuestionService FollowUpQuestionService
@inject IConcernRefinementService ConcernRefinementService
@inject IFhirObservationMapper ObservationMapper
@inject IFhirBundleBuilder BundleBuilder
@inject IConcernRepository ConcernRepository
@inject IFhirServerClient FhirServerClient
@inject JsonSerializerOptions JsonOptions
@inject Microsoft.Extensions.Options.IOptions<LlmProviderOptions> ProviderOptions
@inject Microsoft.Extensions.Options.IOptions<RecordingOptions> RecordingOptions
@inject Microsoft.Extensions.Options.IOptions<FhirServerOptions> FhirServerOptions

<PageTitle>Concern Capture</PageTitle>

<div class="mt-8 grid gap-10 lg:grid-cols-[minmax(0,320px)_minmax(0,1fr)]">
    <aside class="space-y-5">
        <section class="space-y-4">
            <span class="inline-flex items-center gap-2 text-[12px] font-semibold uppercase tracking-[0.3em] text-brand-500">Agentic audio to FHIR</span>
            <h1 class="text-4xl leading-[1.05] tracking-[-0.02em] text-ink-900 sm:text-5xl lg:text-[3.75rem]">Capture Patient Concerns</h1>
            <p class="text-sm leading-6 text-ink-500">
                Record or upload audio, extract concerns, and generate FHIR R4 Observation bundles with a review step.
            </p>
            <div class="flex flex-wrap gap-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-500">
                <span class="rounded-full border border-black/20 bg-surface-soft px-3 py-1">OpenRouter audio</span>
                <span class="rounded-full border border-black/20 bg-surface-soft px-3 py-1">Text: @ProviderOptions.Value.TextProvider</span>
                <span class="rounded-full border border-black/20 bg-surface-soft px-3 py-1">FHIR R4 Observations</span>
            </div>
        </section>

        <section class="rounded-card border border-black/20 bg-surface p-4 shadow-card">
            <div class="text-[12px] font-semibold uppercase tracking-[0.3em] text-ink-500">Table of contents</div>
            <div class="relative mt-4">
                <span class="pointer-events-none absolute left-1 top-2 h-[calc(100%-0.5rem)] w-px bg-black/20"></span>
                <ol class="space-y-3 pl-4 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-500">
                    <li>
                        <a class="group flex items-center gap-3 transition hover:text-ink-900" href="#capture">
                            <span class="text-[12px] text-ink-500">01</span>
                            <span class="mt-0.5 h-1.5 w-1.5 rounded-full bg-brand-500/80 transition group-hover:bg-brand-500"></span>
                            <span class="flex-1 border-b border-black/20 pb-2">Capture</span>
                        </a>
                    </li>
                    <li>
                        <a class="group flex items-center gap-3 transition hover:text-ink-900" href="#concerns">
                            <span class="text-[12px] text-ink-500">02</span>
                            <span class="mt-0.5 h-1.5 w-1.5 rounded-full bg-brand-500/60 transition group-hover:bg-brand-500"></span>
                            <span class="flex-1 border-b border-black/20 pb-2">Extracted concerns</span>
                        </a>
                    </li>
                    <li>
                        <a class="group flex items-center gap-3 transition hover:text-ink-900" href="#followups">
                            <span class="text-[12px] text-ink-500">03</span>
                            <span class="mt-0.5 h-1.5 w-1.5 rounded-full bg-brand-500/60 transition group-hover:bg-brand-500"></span>
                            <span class="flex-1 border-b border-black/20 pb-2">Follow-up questions</span>
                        </a>
                    </li>
                    <li>
                        <a class="group flex items-center gap-3 transition hover:text-ink-900" href="#bundle">
                            <span class="text-[12px] text-ink-500">04</span>
                            <span class="mt-0.5 h-1.5 w-1.5 rounded-full bg-brand-500/60 transition group-hover:bg-brand-500"></span>
                            <span class="flex-1 border-b border-black/20 pb-2">FHIR bundle</span>
                        </a>
                    </li>
                    @if (RecentRecords.Count > 0)
                    {
                        <li>
                            <a class="group flex items-center gap-3 transition hover:text-ink-900" href="#recent">
                                <span class="text-[12px] text-ink-500">05</span>
                                <span class="mt-0.5 h-1.5 w-1.5 rounded-full bg-brand-500/60 transition group-hover:bg-brand-500"></span>
                                <span class="flex-1 border-b border-black/20 pb-2">Recent captures</span>
                            </a>
                        </li>
                    }
                </ol>
            </div>
        </section>

        <TelemetryPanel />
    </aside>

    <div class="space-y-6">
        <section id="capture" class="scroll-mt-24 rounded-card border border-black/20 bg-surface p-4 shadow-card sm:p-5">
            <h2 class="text-lg font-semibold tracking-tight text-ink-900">Capture</h2>
            <div class="mt-4 grid gap-4">
                <div class="space-y-2">
                    <label for="subjectReference" class="text-[12px] font-semibold uppercase tracking-[0.3em] text-ink-700">Subject reference</label>
                    <input id="subjectReference"
                           class="w-full rounded-2xl border border-black/20 bg-surface px-4 py-2.5 text-sm text-ink-900 placeholder:text-ink-500 shadow-sm focus:border-accent-400 focus:outline-none focus:ring-2 focus:ring-accent-200"
                           @bind-value="SubjectReference"
                           @bind-value:event="oninput"
                           placeholder="Patient/123" />
                </div>

                <div class="space-y-2">
                    <label for="subjectDisplay" class="text-[12px] font-semibold uppercase tracking-[0.3em] text-ink-700">Subject display</label>
                    <input id="subjectDisplay"
                           class="w-full rounded-2xl border border-black/20 bg-surface px-4 py-2.5 text-sm text-ink-900 placeholder:text-ink-500 shadow-sm focus:border-accent-400 focus:outline-none focus:ring-2 focus:ring-accent-200"
                           @bind-value="SubjectDisplay"
                           @bind-value:event="oninput"
                           placeholder="Jane Doe" />
                </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full bg-brand-500 px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-950 shadow-raise transition hover:bg-brand-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-200 disabled:cursor-not-allowed disabled:opacity-40"
                        @onclick="StartRecordingAsync"
                        disabled="@IsRecording">
                    Start recording
                </button>
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full border border-black/20 bg-surface px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-700 transition hover:border-black/40 hover:text-ink-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-200 disabled:cursor-not-allowed disabled:opacity-40"
                        @onclick="StopRecordingAsync"
                        disabled="@(!IsRecording || IsProcessing)">
                    Stop & analyze
                </button>
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full border border-black/20 bg-surface px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-700 transition hover:border-black/40 hover:text-ink-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-200 disabled:cursor-not-allowed disabled:opacity-40"
                        @onclick="CancelProcessing"
                        disabled="@(!IsProcessing)">
                    Cancel
                </button>
            </div>

            <div class="mt-4 flex flex-wrap items-center gap-3 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-500">
                <span>Recording</span>
                <span class="rounded-full border border-black/20 bg-surface-soft px-2.5 py-1 text-[12px] font-semibold text-ink-500">@FormatTime(RecordingSeconds) / @FormatTime(MaxRecordingSeconds)</span>
                <span class="text-[12px] text-ink-500 sm:ml-auto">Max @MaxRecordingSeconds s</span>
            </div>

            <div class="mt-4 rounded-2xl border border-dashed border-black/20 bg-surface-soft p-4">
                <InputFile class="block w-full text-sm text-ink-700 file:mr-4 file:rounded-none file:border-0 file:bg-brand-500 file:px-4 file:py-2 file:text-xs file:font-semibold file:text-ink-950 hover:file:bg-brand-400"
                           OnChange="OnFileSelectedAsync"
                           accept="audio/*" />
                <p class="mt-2 text-xs text-ink-500">Recording produces 16 kHz mono WAV. For best results, upload WAV or MP3.</p>
            </div>

            <div class="mt-4 flex items-center gap-3 text-sm font-semibold text-ink-500">
                <span class="h-2.5 w-2.5 rounded-full bg-black/20 transition data-[state=recording]:bg-rose-500 data-[state=recording]:shadow-[0_0_0_6px_rgba(244,63,94,0.2)] data-[state=processing]:bg-amber-400 data-[state=processing]:shadow-[0_0_0_6px_rgba(251,191,36,0.25)] data-[state=ready]:bg-emerald-500 data-[state=ready]:shadow-[0_0_0_6px_rgba(16,185,129,0.2)] data-[state=error]:bg-red-600 data-[state=error]:shadow-[0_0_0_6px_rgba(220,38,38,0.2)]"
                      data-state="@StatusState"></span>
                <span>@StatusMessage</span>
            </div>

            <div class="mt-5 space-y-3">
                <label for="transcript" class="text-[12px] font-semibold uppercase tracking-[0.3em] text-ink-700">Transcript</label>
                <textarea id="transcript"
                          rows="6"
                          class="w-full rounded-2xl border border-black/20 bg-surface px-4 py-2.5 text-sm text-ink-900 placeholder:text-ink-500 shadow-sm focus:border-accent-400 focus:outline-none focus:ring-2 focus:ring-accent-200"
                          @bind-value="Transcript"
                          @bind-value:event="oninput"></textarea>
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full border border-black/20 bg-surface px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-700 transition hover:border-black/40 hover:text-ink-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-200 disabled:cursor-not-allowed disabled:opacity-40"
                        @onclick="ExtractFromTranscriptAsync"
                        disabled="@(IsProcessing || string.IsNullOrWhiteSpace(Transcript))">
                    Extract from text
                </button>
            </div>
        </section>

        <section id="concerns" class="scroll-mt-24 rounded-card border border-black/20 bg-surface p-4 shadow-card sm:p-5">
            <h2 class="text-lg font-semibold tracking-tight text-ink-900">Extracted concerns</h2>
            @if (Concerns.Count == 0)
            {
                <p class="mt-2 text-sm text-ink-700">No concerns extracted yet.</p>
            }
            else
            {
                <div class="mt-4 space-y-4">
                    @foreach (var concern in Concerns)
                    {
                        <div class="rounded-2xl border border-black/20 bg-surface p-4">
                            <div class="text-sm font-semibold text-ink-900">@concern.Summary</div>
                            <div class="mt-2 flex flex-wrap gap-2 text-xs text-ink-500">
                                <span>Severity: @(string.IsNullOrWhiteSpace(concern.Severity) ? "unknown" : concern.Severity)</span>
                                @if (!string.IsNullOrWhiteSpace(concern.Onset))
                                {
                                    <span>Onset: @concern.Onset</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(concern.Duration))
                                {
                                    <span>Duration: @concern.Duration</span>
                                }
                            </div>
                            @if (!string.IsNullOrWhiteSpace(concern.Impact))
                            {
                                <div class="mt-2 text-sm text-ink-700">Impact: @concern.Impact</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(concern.Context))
                            {
                                <div class="mt-2 text-sm text-ink-700">Context: @concern.Context</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(concern.PatientQuote))
                            {
                                <div class="mt-3 border-l-4 border-brand-300/80 pl-3 text-sm italic text-ink-500">"@concern.PatientQuote"</div>
                            }
                        </div>
                    }
                </div>
            }

            <h2 id="followups" class="scroll-mt-24 mt-8 text-lg font-semibold tracking-tight text-ink-900">Follow-up questions</h2>
            <div class="mt-4 rounded-2xl border border-black/20 bg-surface p-4">
                <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
                    <div>
                        <div class="text-sm font-semibold text-ink-700">Agentic follow-up</div>
                        <div class="text-sm text-ink-500">Generate targeted questions for missing severity, onset, duration, impact, and context.</div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                                class="inline-flex items-center justify-center rounded-full border border-black/20 bg-surface px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-700 transition hover:border-black/40 hover:text-ink-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-200 disabled:cursor-not-allowed disabled:opacity-40"
                                @onclick="GenerateFollowUpsAsync"
                                disabled="@(!CanGenerateFollowUps)">
                            Generate questions
                        </button>
                        <button type="button"
                                class="inline-flex items-center justify-center rounded-full bg-brand-500 px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-950 shadow-raise transition hover:bg-brand-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-200 disabled:cursor-not-allowed disabled:opacity-40"
                                @onclick="ApplyFollowUpAnswersAsync"
                                disabled="@(!CanApplyFollowUps)">
                            Apply answers
                        </button>
                    </div>
                </div>

                @if (FollowUpEntries.Count == 0)
                {
                    <p class="mt-4 text-sm text-ink-500">No follow-up questions yet.</p>
                }
                else
                {
                    <div class="mt-4 space-y-4">
                        @foreach (var entry in FollowUpEntries)
                        {
                            <div class="rounded-2xl border border-black/20 bg-surface p-4">
                                <div class="text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-500">@entry.Question.ConcernSummary</div>
                                <div class="mt-2 text-sm font-semibold text-ink-700">@entry.Question.Question</div>
                                <textarea rows="2"
                                          class="mt-2 w-full rounded-2xl border border-black/20 bg-surface px-3 py-2 text-sm text-ink-900 placeholder:text-ink-500 shadow-sm focus:border-accent-400 focus:outline-none focus:ring-2 focus:ring-accent-200"
                                          @bind-value="entry.Answer"
                                          @bind-value:event="oninput"
                                          placeholder="Type the patient response"></textarea>
                            </div>
                        }
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(FollowUpStatusMessage))
                {
                    <div class="mt-3 text-sm text-ink-500">@FollowUpStatusMessage</div>
                }
            </div>

            <div class="mt-5 flex flex-wrap gap-2">
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full bg-brand-500 px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-950 shadow-raise transition hover:bg-brand-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-200 disabled:cursor-not-allowed disabled:opacity-40"
                        @onclick="SaveAsync"
                        disabled="@(!CanSave)">
                    Save to SQL
                </button>
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full border border-black/20 bg-surface px-4 py-2 text-[12px] font-semibold uppercase tracking-[0.2em] text-ink-700 transition hover:border-black/40 hover:text-ink-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-200 disabled:cursor-not-allowed disabled:opacity-40"
                        @onclick="SendToFhirAsync"
                        disabled="@(!CanSendToFhir)">
                    Send to FHIR
                </button>
            </div>
            @if (!string.IsNullOrWhiteSpace(FhirStatusMessage))
            {
                <div class="mt-3 text-sm text-ink-500">@FhirStatusMessage</div>
            }
            else if (!IsFhirConfigured)
            {
                <div class="mt-3 text-sm text-ink-500">Configure FhirServer:BaseUrl to enable sending.</div>
            }

            <h2 id="bundle" class="scroll-mt-24 mt-8 text-lg font-semibold tracking-tight text-ink-900">FHIR Observation bundle</h2>
            @if (string.IsNullOrWhiteSpace(BundleJson))
            {
                <p class="mt-2 text-sm text-ink-500">Bundle JSON will appear here after extraction.</p>
            }
            else
            {
                <pre class="mt-3 max-h-80 overflow-auto rounded-2xl bg-ink-950 p-4 text-xs text-white/80 shadow-inner">@BundleJson</pre>
            }
        </section>

        @if (RecentRecords.Count > 0)
        {
            <section id="recent" class="scroll-mt-24 rounded-card border border-black/20 bg-surface p-4 shadow-card sm:p-5">
                <h2 class="text-lg font-semibold tracking-tight text-ink-900">Recent captures</h2>
                <div class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
                    @foreach (var record in RecentRecords)
                    {
                        <div class="rounded-2xl border border-black/20 bg-surface p-4">
                            <div class="text-sm font-semibold text-ink-900">@record.CreatedAtUtc.ToLocalTime().ToString("g")</div>
                            <div class="mt-1 text-sm text-ink-500">@(record.SubjectDisplay ?? record.SubjectReference ?? "Unknown subject")</div>
                        </div>
                    }
                </div>
            </section>
        }
    </div>
</div>
@code {
    private string SubjectReference { get; set; } = string.Empty;
    private string SubjectDisplay { get; set; } = string.Empty;
    private string Transcript { get; set; } = string.Empty;
    private string StatusMessage { get; set; } = "Ready.";
    private string StatusState { get; set; } = "idle";
    private string BundleJson { get; set; } = string.Empty;
    private string FhirStatusMessage { get; set; } = string.Empty;
    private string FollowUpStatusMessage { get; set; } = string.Empty;
    private int RecordingSeconds { get; set; }

    private bool IsRecording { get; set; }
    private bool IsProcessing { get; set; }
    private bool IsSendingToFhir { get; set; }

    private List<ConcernItem> Concerns { get; } = [];
    private List<ConcernRecord> RecentRecords { get; } = [];
    private List<FollowUpEntry> FollowUpEntries { get; } = [];
    private CancellationTokenSource? ProcessingCts { get; set; }
    private CancellationTokenSource? RecordingTimerCts { get; set; }

    private bool CanSave => !IsProcessing && Concerns.Count > 0 && !string.IsNullOrWhiteSpace(BundleJson);
    private bool IsFhirConfigured => !string.IsNullOrWhiteSpace(FhirServerOptions.Value.BaseUrl);
    private bool CanSendToFhir => IsFhirConfigured && !IsProcessing && !IsSendingToFhir && !string.IsNullOrWhiteSpace(BundleJson);
    private int MaxRecordingSeconds => RecordingOptions.Value.MaxSeconds;
    private long MaxAudioBytes => RecordingOptions.Value.MaxAudioBytes;
    private bool CanGenerateFollowUps => !IsProcessing && !IsRecording && Concerns.Count > 0;
    private bool CanApplyFollowUps =>
        !IsProcessing && !IsRecording && FollowUpEntries.Any(entry => !string.IsNullOrWhiteSpace(entry.Answer));

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentAsync();
    }

    private async Task StartRecordingAsync()
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("audioRecorder.start");
            IsRecording = true;
            RecordingSeconds = 0;
            FhirStatusMessage = string.Empty;
            ResetFollowUps();
            StartRecordingTimer();
            StatusMessage = "Recording...";
            StatusState = "recording";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Recording failed: {ex.Message}";
            StatusState = "error";
        }
    }

    private async Task StopRecordingAsync()
    {
        if (!IsRecording)
        {
            return;
        }

        IsRecording = false;
        ResetProcessing();
        ResetFollowUps();
        IsProcessing = true;
        StopRecordingTimer();
        StatusMessage = "Processing audio...";
        StatusState = "processing";

        try
        {
            var response = await JsRuntime.InvokeAsync<ProcessingResponse>(
                "audioRecorder.stopAndProcess",
                ProcessingToken,
                SubjectReference,
                SubjectDisplay);

            if (string.IsNullOrWhiteSpace(response.Transcript))
            {
                StatusMessage = "No audio captured.";
                StatusState = "idle";
                return;
            }

            Transcript = response.Transcript;
            Concerns.Clear();
            Concerns.AddRange(response.Concerns);
            BundleJson = response.BundleJson;
            StatusMessage = "Analysis complete.";
            StatusState = "ready";
        }
        catch (OperationCanceledException)
        {
            StatusMessage = "Processing canceled.";
            StatusState = "idle";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Stop failed: {ex.Message}";
            StatusState = "error";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task OnFileSelectedAsync(InputFileChangeEventArgs args)
    {
        var file = args.File;
        if (file is null)
        {
            return;
        }

        ResetProcessing();
        ResetFollowUps();
        FhirStatusMessage = string.Empty;
        StatusMessage = "Processing audio file...";
        StatusState = "processing";

        try
        {
            using var stream = file.OpenReadStream(MaxAudioBytes);
            using var memory = new MemoryStream();
            await stream.CopyToAsync(memory, ProcessingToken);
            var base64 = Convert.ToBase64String(memory.ToArray());

            await ProcessAudioAsync(new AudioInput(base64, file.ContentType));
        }
        catch (Exception ex)
        {
            StatusMessage = $"Upload failed: {ex.Message}";
            StatusState = "error";
        }
    }

    private async Task ExtractFromTranscriptAsync()
    {
        if (string.IsNullOrWhiteSpace(Transcript))
        {
            return;
        }

        ResetProcessing();
        IsProcessing = true;
        ResetFollowUps();
        FhirStatusMessage = string.Empty;
        StatusMessage = "Extracting concerns...";
        StatusState = "processing";

        try
        {
            var extraction = await ConcernExtractionService
                .ExtractAsync(Transcript, ProcessingToken);

            UpdateResults(extraction);
            StatusMessage = "Extraction complete.";
            StatusState = "ready";
        }
        catch (OperationCanceledException)
        {
            StatusMessage = "Extraction canceled.";
            StatusState = "idle";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Extraction failed: {ex.Message}";
            StatusState = "error";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ProcessAudioAsync(AudioInput audioInput)
    {
        ResetProcessing();
        IsProcessing = true;
        ResetFollowUps();

        try
        {
            var context = new ProcessingContext(
                string.IsNullOrWhiteSpace(SubjectReference) ? null : SubjectReference,
                string.IsNullOrWhiteSpace(SubjectDisplay) ? null : SubjectDisplay);

            var result = await AudioProcessingService
                .ProcessAsync(audioInput, context, ProcessingToken);

            Transcript = result.Transcript;
            Concerns.Clear();
            Concerns.AddRange(result.Concerns);
            BundleJson = JsonSerializer.Serialize(result.Bundle, JsonOptions);
            StatusMessage = "Analysis complete.";
            StatusState = "ready";
        }
        catch (OperationCanceledException)
        {
            StatusMessage = "Processing canceled.";
            StatusState = "idle";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Processing failed: {ex.Message}";
            StatusState = "error";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task SaveAsync()
    {
        if (!CanSave)
        {
            return;
        }

        try
        {
            var record = new ConcernRecord
            {
                Transcript = Transcript,
                ConcernsJson = JsonSerializer.Serialize(Concerns, JsonOptions),
                FhirBundleJson = BundleJson,
                SubjectReference = string.IsNullOrWhiteSpace(SubjectReference) ? null : SubjectReference,
                SubjectDisplay = string.IsNullOrWhiteSpace(SubjectDisplay) ? null : SubjectDisplay
            };

            await ConcernRepository.AddAsync(record, CancellationToken.None);
            StatusMessage = "Saved.";
            StatusState = "ready";

            await LoadRecentAsync();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Save failed: {ex.Message}";
            StatusState = "error";
        }
    }

    private async Task LoadRecentAsync()
    {
        RecentRecords.Clear();
        var records = await ConcernRepository
            .GetRecentAsync(6, CancellationToken.None);
        RecentRecords.AddRange(records);
    }

    private void UpdateResults(ConcernExtractionResult extraction)
    {
        Concerns.Clear();
        Concerns.AddRange(extraction.Concerns);
        UpdateBundle(Concerns);
    }

    private void UpdateBundle(IReadOnlyList<ConcernItem> concerns)
    {
        FhirStatusMessage = string.Empty;

        var context = new ProcessingContext(
            string.IsNullOrWhiteSpace(SubjectReference) ? null : SubjectReference,
            string.IsNullOrWhiteSpace(SubjectDisplay) ? null : SubjectDisplay);

        var observations = ObservationMapper.Map(concerns, context, DateTimeOffset.UtcNow);
        var bundle = BundleBuilder.Build(observations);
        BundleJson = JsonSerializer.Serialize(bundle, JsonOptions);
    }

    private async Task GenerateFollowUpsAsync()
    {
        if (!CanGenerateFollowUps)
        {
            return;
        }

        ResetProcessing();
        IsProcessing = true;
        FollowUpStatusMessage = "Generating follow-up questions...";
        StatusMessage = "Generating follow-up questions...";
        StatusState = "processing";

        try
        {
            var questions = await FollowUpQuestionService
                .GenerateAsync(Transcript, Concerns, ProcessingToken);

            FollowUpEntries.Clear();
            foreach (var question in questions)
            {
                FollowUpEntries.Add(new FollowUpEntry(question));
            }

            FollowUpStatusMessage = FollowUpEntries.Count == 0
                ? "No follow-up questions needed."
                : "Answer the questions and apply the updates.";
            StatusMessage = "Follow-up questions ready.";
            StatusState = "ready";
        }
        catch (OperationCanceledException)
        {
            FollowUpStatusMessage = "Follow-up generation canceled.";
            StatusMessage = "Follow-up generation canceled.";
            StatusState = "idle";
        }
        catch (Exception ex)
        {
            FollowUpStatusMessage = $"Follow-up generation failed: {ex.Message}";
            StatusMessage = $"Follow-up generation failed: {ex.Message}";
            StatusState = "error";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ApplyFollowUpAnswersAsync()
    {
        if (!CanApplyFollowUps)
        {
            return;
        }

        ResetProcessing();
        IsProcessing = true;
        FollowUpStatusMessage = "Applying follow-up answers...";
        StatusMessage = "Applying follow-up answers...";
        StatusState = "processing";

        try
        {
            var answers = FollowUpEntries
                .Where(entry => !string.IsNullOrWhiteSpace(entry.Answer))
                .Select(entry => new FollowUpAnswer(
                    entry.Question.ConcernIndex,
                    entry.Question.Field,
                    entry.Answer.Trim()))
                .ToList();

            var updated = await ConcernRefinementService
                .ApplyAnswersAsync(Transcript, Concerns, answers, ProcessingToken);

            Concerns.Clear();
            Concerns.AddRange(updated);
            UpdateBundle(Concerns);

            FollowUpStatusMessage = "Concerns updated with follow-up answers.";
            StatusMessage = "Concerns updated.";
            StatusState = "ready";
        }
        catch (OperationCanceledException)
        {
            FollowUpStatusMessage = "Follow-up apply canceled.";
            StatusMessage = "Follow-up apply canceled.";
            StatusState = "idle";
        }
        catch (Exception ex)
        {
            FollowUpStatusMessage = $"Follow-up apply failed: {ex.Message}";
            StatusMessage = $"Follow-up apply failed: {ex.Message}";
            StatusState = "error";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task SendToFhirAsync()
    {
        if (!CanSendToFhir)
        {
            return;
        }

        IsSendingToFhir = true;
        FhirStatusMessage = "Sending bundle to FHIR server...";

        try
        {
            var result = await FhirServerClient
                .UploadBundleAsync(BundleJson, CancellationToken.None);

            FhirStatusMessage = result.Success
                ? (string.IsNullOrWhiteSpace(result.Location)
                    ? "FHIR server accepted the bundle."
                    : $"FHIR server accepted the bundle: {result.Location}")
                : $"FHIR server returned {result.StatusCode}.";
        }
        catch (Exception ex)
        {
            FhirStatusMessage = $"FHIR send failed: {ex.Message}";
        }
        finally
        {
            IsSendingToFhir = false;
        }
    }

    private void CancelProcessing()
    {
        ProcessingCts?.Cancel();
    }

    private void ResetProcessing()
    {
        ProcessingCts?.Cancel();
        ProcessingCts?.Dispose();
        ProcessingCts = new CancellationTokenSource();
    }

    private void ResetFollowUps()
    {
        FollowUpEntries.Clear();
        FollowUpStatusMessage = string.Empty;
    }

    private void StartRecordingTimer()
    {
        RecordingTimerCts?.Cancel();
        RecordingTimerCts?.Dispose();
        RecordingTimerCts = new CancellationTokenSource();
        _ = RunRecordingTimerAsync(RecordingTimerCts.Token);
    }

    private void StopRecordingTimer()
    {
        RecordingTimerCts?.Cancel();
        RecordingTimerCts?.Dispose();
        RecordingTimerCts = null;
    }

    private async Task RunRecordingTimerAsync(CancellationToken cancellationToken)
    {
        try
        {
            using var timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
            while (await timer.WaitForNextTickAsync(cancellationToken))
            {
                if (!IsRecording)
                {
                    return;
                }

                RecordingSeconds++;
                await InvokeAsync(StateHasChanged);

                if (RecordingSeconds >= MaxRecordingSeconds)
                {
                    await InvokeAsync(StopRecordingAsync);
                    return;
                }
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when stopping the recording timer.
        }
    }

    private static string FormatTime(int totalSeconds)
    {
        var minutes = totalSeconds / 60;
        var seconds = totalSeconds % 60;
        return $"{minutes:00}:{seconds:00}";
    }

    private CancellationToken ProcessingToken => ProcessingCts?.Token ?? CancellationToken.None;

    private sealed class FollowUpEntry
    {
        public FollowUpEntry(FollowUpQuestion question)
        {
            Question = question;
        }

        public FollowUpQuestion Question { get; }

        public string Answer { get; set; } = string.Empty;
    }

    public void Dispose()
    {
        StopRecordingTimer();
        ProcessingCts?.Cancel();
        ProcessingCts?.Dispose();
    }
}
